#include <string.h>
#include <stdlib.h>

#include "sys_autorun.h"
#include "sys_mq.h"
#include "spo2.h"
#include "co2.h"


unsigned int order_spo2=0;
unsigned int count_spo2=0;
unsigned int count_IBP=0;
unsigned int count_co2=0;
unsigned int table_i=0, table_j, co2_i=0;
unsigned char Delay_=0, Delay2=0;
unsigned int count_EKG=0,count_EKG_RESP=0;
int IBP_autorun_delay=0;
int all_data_autorun_count;
int IBP_chang_NIBP;
int sho_autodata_count=100;
unsigned int spo2_table[23][4] = {
{80,71,1,0},
{82,73,2,0},
{84,75,3,0},
{86,77,4,0},
{88,79,5,0},
{90,81,6,0},
{91,83,7,0},
{92,85,8,0},
{93,87,8,0}, // 10
{94,89,9,0},
{95,91,9,0},
{96,93,0,0},
{95,92,1,0},
{94,90,2,0},
{93,88,3,0},
{92,86,4,0},
{91,84,5,0},
{90,82,6,0},
{88,80,7,0}, // 20
{86,78,8,0},
{84,76,9,0},
{82,74,0,0},
{80,72,0,0},
};

unsigned int spo2_curve[] = {
0x9C, 0x9F, 0xA1, 0xA3, 0xA4, 0xA4, 0xA4, 0xA2, 0xA0, 0x9E,
0x9B, 0x99, 0x97, 0x94, 0x92, 0x8F, 0x8C, 0x88, 0x85, 0x82,
0x7F, 0x7D, 0x7A, 0x77, 0x75, 0x73, 0x71, 0x6F, 0x6E, 0x6C,
0x6B, 0x69, 0x68, 0x66, 0x65, 0x64, 0x62, 0x61, 0x60, 0x60,
0x60, 0x62, 0x68, 0x70, 0x7B, 0x85, 0x8F
};
unsigned int IBP_curve[] = {
0x09,0x0A,0x0B,0x0C,0x0D,0x0F,0x10,0x11,0x12,0x14,
0x16,0x17,0x19,0x1B,0x1D,0x1E,0x1F,0x21,0x22,0x23,
0x25,0x26,0x27,0x27,0x29,0x29,0x2A,0x2B,0x2B,0x2C,
0x2C,0x2D,0x2D,0x2D,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,
0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2E,
0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,
0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,
0x2E,0x2E,0x2E,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,
0x2F,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2E,0x2D,0x2D,
0x2C,0x2C,0x2C,0x2B,0x2A,0x2A,0x29,0x28,0x27,0x26,
0x25,0x23,0x22,0x21,0x20,0x1E,0x1D,0x1B,0x19,0x17,
0x16,0x15,0x14,0x12,0x11,0x10,0x10,0x0E,0x0E,0x0D,
0x0D,0x0C,0x0B,0x0B,0x0A,0x0A,0x09,0x08,0x08,0x08,
0x08,0x07,0x07,0x07,0x06,0x06,0x06,0x06,0x06,0x05,
0x05,0x05,0x05,0x05,0x05,0x05,0x04,0x04,0x04,0x04,
0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,
0x04,0x04,0x04,0x05,0x05,0x05,0x05,0x05,0x05,0x05,
0x05,0x05,0x05,0x05,0x05,0x05,0x05,0x06,0x06,0x06,
0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x07,
0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x08,0x08,
0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,
0x08,0x09
};
unsigned int co2_table[19] = {
380,360,360,360,360,380,380,380,380,370,370,370,370,380,380,380,380,380,380
};

unsigned int resp_table[19] = {
12,10,10,10,10,10,10,8,8,8,8,8,8,10,10,10,10,10,10
};
unsigned int EKG_curve[] =
{
114,114,114,114,114,114,114,115,115,115,115,115,115,116,116,116,
116,116,116,116,117,117,120,124,126,127,127,125,122,119,117,117,
117,117,117,117,118,117,120,137,161,181,184,160,133,112,109,114,
115,115,115,115,115,116,118,121,125,129,133,136,137,138,138,137,
136,134,131,127,123,119,116,114,114,114,114,114,114,114,115,115,
115,115,115,115,115,115,116,116,116,116,116,116,117,120,123,126,
127,126,124,121,118,117,116,116,117,117,117,117,116,119,137,160,
181,183,160,133,112,108,113,113,114,114,114,114,115,117,120,124,
127,132,135,136,137,137,136,135,133,130,126,122,118,115,113,113,
113,113,113,113,114,114,114,114,114,115,115,115,115,115,115,115,
115,116,116,117,119,123,125,126,126,124,121,118,116,116,116,116,
117,117,117,116,119,136,159,180,184,162,136,113,108,113,114,114,
114,114,115,115,117,121,124,128,132,135,137,137,138,137,136,134,
131,127,123,120,116,114,114,114,114,114,114,114,115,115,115,115,
115,116,116,116,116,116,116,117,117,117,117,120,123,126,127,127,
125,123,119,118,117,117,117,117,118,118,117,118,133,158,178,186,
166,139,116,108,113,114,114,115,115,115,115,117,120,123,127,131,
134,136,137,138,137,136,135,132,128,124,120,117,114,114,114,114,
114,114,114,114,114,115,115,115,115,115,115,115,115,116,116,116,
116,116,119,122,125,126,126,125,122,119,117,116,116,116,116,116,
116,116,116,129,153,175,186,168,141,117,107,112,114,113,114,114,
114,114,116,119,123,126,130,134,136,137,137,137,136,134,132,127,
123,120,116,114,113,113,113,114,114,114,114,114,114,115,115,115,
115,115,115,116,116,116,116,116,117,119,122,125,127,127,125,123,
119,117,117,117,117,117,117,117,117,117,128,151,174,186,172,145,
120,108,112,115,114,115,115,115,115,117,120,123,127,131,135,137,
138,138,138,137,135,133,129,124,121,118,115,114,114,114,115,115};
unsigned int EKG_RESP_curve[] = {
32,32,32,32,32,32,32,32,32,33,33,33,34,34,35,36,36,37,38,39,40,41,
44,45,47,48,50,51,53,55,56,58,60,62,64,66,68,71,73,77,80,82,85,87,
90,92,95,97,100,102,105,108,110,113,116,121,124,126,129,132,134,137,
140,142,145,147,150,152,155,157,160,162,165,169,171,174,176,178,180,
182,184,186,187,189,191,193,194,196,197,199,201,203,204,205,206,207,
208,209,209,210,211,211,212,213,213,213,214,214,214,214,214,214,214,
214,213,213,213,212,212,211,211,210,210,209,207,207,206,205,204,203,
202,202,201,200,199,198,197,196,195,194,192,191,190,189,188,187,186,
185,184,183,182,181,179,178,177,176,175,174,172,170,169,168,167,166,
165,163,162,161,160,159,157,156,155,154,153,150,149,148,147,146,145,
143,142,141,140,139,138,137,136,135,133,132,130,129,128,127,126,125,
123,122,121,120,119,118,116,115,114,113,112,111,108,107,106,105,104,
102,101,100,99,98,96,95,94,93,92,91,89,87,86,85,84,83,82,81,80,79,77,
76,75,74,73,72,70,68,67,66,65,64,63,62,60,59,58,57,56,55,54,53,52,50,
49,48,47,46,45,44,43,42,41,41,40,39,39,38,38,37,36,36,35,35,34,34,34
};
unsigned int co2_curve[] = { // 449
//10110000b,00001100b,10000001b,01111100b,
0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C,
0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C,
0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0C,
0xA8, 0x0C, 0xA8, 0x0C, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0A,
0xA8, 0x0A, 0xA8, 0x0A, 0xA8, 0x0A, 0xA8, 0x0A, 0xA8, 0x0A,
0xA8, 0x0A, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B,
0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0B, 0xA8, 0x0C, 0xA8, 0x0C,
0xA8, 0x0C, 0xA8, 0x0D, 0xA8, 0x0D, 0xA8, 0x0E, 0xA8, 0x10, 0xA8, 0x12,
0xA8, 0x15, 0xA8, 0x19, 0xA8, 0x1D, 0xA8, 0x23, 0xA8, 0x29, 0xA8, 0x31,
0xA8, 0x39, 0xA8, 0x42, 0xA8, 0x4B, 0xA8, 0x55, 0xA8, 0x61, 0xA8, 0x6B,
0xA8, 0x75, 0xA8, 0x7E, 0xAC, 0x07, 0xAC, 0x11, 0xAC, 0x19, 0xAC, 0x20,
0xAC, 0x27, 0xAC, 0x2E, 0xAC, 0x34, 0xAC, 0x39, 0xAC, 0x40, 0xAC, 0x44,
0xAC, 0x48, 0xAC, 0x4C, 0xAC, 0x4F, 0xAC, 0x54, 0xAC, 0x56, 0xAC, 0x58,
0xAC, 0x5A, 0xAC, 0x5C, 0xAC, 0x5F, 0xAC, 0x61, 0xAC, 0x64, 0xAC, 0x66,
0xAC, 0x68, 0xAC, 0x69, 0xAC, 0x6B, 0xAC, 0x6C, 0xAC, 0x6E, 0xAC, 0x6F,
0xAC, 0x70, 0xAC, 0x71, 0xAC, 0x73, 0xAC, 0x74, 0xAC, 0x75, 0xAC, 0x75,
0xAC, 0x76, 0xAC, 0x77, 0xAC, 0x78, 0xAC, 0x78, 0xAC, 0x78, 0xAC, 0x78,
0xAC, 0x79, 0xAC, 0x7B, 0xAC, 0x7B, 0xAC, 0x7B, 0xAC, 0x7C, 0xAC, 0x7E,
0xAC, 0x7F, 0xAC, 0x7F, 0xAC, 0x7F, 0xA9, 0x00, 0xA9, 0x00, 0xA9, 0x00,
0xA9, 0x01, 0xA9, 0x01, 0xA9, 0x01, 0xA9, 0x03, 0xA9, 0x04, 0xA9, 0x04,
0xA9, 0x04, 0xA9, 0x07, 0xA9, 0x07, 0xA9, 0x07, 0xA9, 0x07,
0xA9, 0x07, 0xA9, 0x09, 0xA9, 0x0A, 0xA9, 0x0A, 0xA9, 0x0A, 0xA9, 0x0A,
0xA9, 0x0B, 0xA9, 0x0B, 0xA9, 0x0B, 0xA9, 0x0B, 0xA9, 0x0C, 0xA9, 0x0C,
0xA9, 0x0D, 0xA9, 0x0E, 0xA9, 0x0F, 0xA9, 0x10, 0xA9, 0x10, 0xA9, 0x12,
0xA9, 0x12, 0xA9, 0x12, 0xA9, 0x12, 0xA9, 0x13, 0xA9, 0x14, 0xA9, 0x14,
0xA9, 0x15, 0xA9, 0x15, 0xA9, 0x16, 0xA9, 0x17, 0xA9, 0x17, 0xA9, 0x18,
0xA9, 0x18, 0xA9, 0x18, 0xA9, 0x18, 0xA9, 0x1B, 0xA9, 0x1B, 0xA9, 0x1B,
0xA9, 0x1C, 0xA9, 0x1C, 0xA9, 0x1C, 0xA9, 0x1D, 0xA9, 0x1D, 0xA9, 0x1D,
0xA9, 0x1D, 0xA9, 0x1D, 0xA9, 0x1E, 0xA9, 0x1E, 0xA9, 0x1E, 0xA9, 0x1F,
0xA9, 0x1E, 0xA9, 0x1E, 0xA9, 0x1D, 0xA9, 0x1D, 0xA9, 0x1B, 0xA9, 0x18,
0xA9, 0x14, 0xA9, 0x0F, 0xA9, 0x0A, 0xA9, 0x02, 0xAC, 0x79, 0xAC, 0x6F,
0xAC, 0x63, 0xAC, 0x56, 0xAC, 0x48, 0xAC, 0x38, 0xAC, 0x2A, 0xAC, 0x1C,
0xAC, 0x0D, 0xAC, 0x00, 0xA8, 0x73, 0xA8, 0x68, 0xA8, 0x5E,
0xA8, 0x54, 0xA8, 0x4B, 0xA8, 0x44, 0xA8, 0x3E, 0xA8, 0x39, 0xA8, 0x35,
0xA8, 0x31, 0xA8, 0x2C, 0xA8, 0x28, 0xA8, 0x25, 0xA8, 0x23, 0xA8, 0x20,
0xA8, 0x1E, 0xA8, 0x1B, 0xA8, 0x1A, 0xA8, 0x19, 0xA8, 0x18, 0xA8, 0x18,
0xA8, 0x17, 0xA8, 0x17, 0xA8, 0x16, 0xA8, 0x16, 0xA8, 0x15, 0xA8, 0x14,
0xA8, 0x13, 0xA8, 0x12, 0xA8, 0x11, 0xA8, 0x10, 0xA8, 0x10, 0xff
};
void all_data_autorun(void)
 {
   if(Get_DEMO_MOD_ONOFF())
    {
     if(all_data_autorun_count<8) all_data_autorun_count++;
     else all_data_autorun_count=0;
     if(all_data_autorun_count%1==0)
      {
        IBP_autorun();
     EKG_autorun();
      }
     if(all_data_autorun_count%2==0)
      {
      co2_autorun(); // for etco2 AutoRun 
        
      }
     if(all_data_autorun_count%3==0)
      {
      
        
       
     sho_autodata_count++;
         EKG_auto_data(24+(all_data_autorun_count%3)-1,80+(all_data_autorun_count%3));        
        
      spo2_autorun(); // for spo2 AutoRun  
      }
     if(sho_autodata_count>20)
      {
        sho_autodata_count=0;
        IBP_chang_NIBP++;
        IBP_auto_data((int )(215+(2*all_data_autorun_count%2)),
           (int )170+(1*all_data_autorun_count%2),
           (int )190+(1*all_data_autorun_count%7),(int )82);        
      }
     if(IBP_chang_NIBP==5)
      {
        CleaAllAlarm();
        IBP_chang_NIBP=0;
        NIBP_auto_data(112,68,87,80);
        //Send_Internet_data_NIBP();//202107
        NIBP_show_time(2);
        mem_NIBP_write();
      }
    }
 }

void spo2_autorun(void)
{
  switch (order_spo2)
  {
    case 0:
      order_spo2 = 1;
      table_j = 0;
      PutMessage(Get_WhoUnpack(UART_1), header_spo2);
      PutMessage(Get_WhoUnpack(UART_1), spo2_table[table_i][table_j++]);
      PutMessage(Get_WhoUnpack(UART_1), header_puls);
      PutMessage(Get_WhoUnpack(UART_1), spo2_table[table_i][table_j++]);
      PutMessage(Get_WhoUnpack(UART_1), header_quty);
      PutMessage(Get_WhoUnpack(UART_1), spo2_table[table_i][table_j++]);
      PutMessage(Get_WhoUnpack(UART_1), header_info);
      PutMessage(Get_WhoUnpack(UART_1), spo2_table[table_i][table_j++]);
      if(spo2_table[table_i][0] == 96 || spo2_table[table_i][0] == 78)
      {
        if(Delay_++ == 180)
        {
          Delay_ = 0;
          table_i++;
        }
      }
      else	table_i++;
      
      if(table_i > 22) table_i = 0;
    break;
    case 1:
      order_spo2 = 2;
      PutMessage(Get_WhoUnpack(UART_1), header_wave);
      PutMessage(Get_WhoUnpack(UART_1), (spo2_curve[count_spo2++]-85)*2);
    case 2:
      PutMessage(Get_WhoUnpack(UART_1), (spo2_curve[count_spo2++]-85)*2);
      if(count_spo2>46) count_spo2=0, order_spo2=0;
    break;
  }
}
void EKG_autorun(void)
{

       //for(int i=0;i<496;i++)
 //    PutMessage(Get_WhoUnpack(UART_2), EKG_curve[count_EKG++]);
    EKG_auto_wave(EKG_curve[count_EKG++],EKG_RESP_curve[count_EKG_RESP++]/2);
    if(count_EKG>430) count_EKG=0;
    if(count_EKG_RESP>280) count_EKG_RESP=0;
    if(Get_DEMO_MOD_ONOFF()){
     if(Get_StateMachineStatus() == ST_MainScreen)
        {

            //if(!Get_OFF())
            EKG_draw_wave();
          EKG_draw_wave();
          EKG_draw_wave();
          EKG_draw_wave();
        }
    }
  //  PutMessage(MSG_DrawEKGWave,0);
  
}
void IBP_autorun(void)
{

      IBP_auto_wave(IBP_curve[count_IBP++]+2);
      IBP_auto_wave(IBP_curve[count_IBP++]+2);
     IBP_auto_wave(IBP_curve[count_IBP++]+2);
      //PutMessage(Get_WhoUnpack(UART_7), (IBP_curve[count_IBP++]-70)*2);
     // PutMessage(MSG_DrawIBPWave,0);

    if(count_IBP>=208) count_IBP=0;

  
}

void co2_autorun(void)
{
  change_etco2_value(co2_table[co2_i]);
  change_resp_value(resp_table[co2_i]);
  if(co2_table[co2_i] == 380)
  {
    if(Delay2++ == 90)
    {
      Delay2 = 0;
      co2_i++;
    }
  }
  else
  {
    if(Delay2++ == 30)
    {
      Delay2 = 0;
      co2_i++;
    }
  }
	
  if(co2_i>18) co2_i=0;

  PutMessage(Get_WhoUnpack(UART_3), (int)(co2_curve[count_co2++]));
  if(count_co2>448) count_co2=0;
}
